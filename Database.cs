using System.Data.SQLite;

namespace MalwareBlock {
    public class Database {
        private static readonly SQLiteConnection Connection = new SQLiteConnection(@"Data Source=db\malwareblock.sqlite");

        private static bool Connected() {
            try {
                Connection.Open();
                return true;
            } catch (SQLiteException) {
                return false;
            }
        }

        public static (string?, string?) RetrieveData(string sha256) {
            string? name = null, dig = null;
            string sql = @$"
SELECT * FROM malwares
WHERE sha256='{sha256}';";

            while (true) {
                if (Connected()) {
                    SQLiteCommand cmd = new SQLiteCommand(sql, Connection);

                    using (SQLiteDataReader reader = cmd.ExecuteReader()) {
                        while (reader.Read()) {
                            name = reader.GetString(1);
                            dig = reader.GetString(2);
                        }
                    }

                    Connection.Close();
                    break;
                } else {
                    DialogResult err = MessageBox.Show(
                        "Error connecting to database",
                        "MalwareBlock - ERROR",
                        MessageBoxButtons.RetryCancel,
                        MessageBoxIcon.Error
                        );

                    if (err == DialogResult.Cancel)
                        Environment.Exit(1);
                }
            }

            return (name, dig);
        }
    }
}
